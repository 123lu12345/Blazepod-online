
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BlazePod Dashboard</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #0e5c78;
      color: white;
      padding: 1rem;
    }
    .spiel-item {
      background: rgba(255, 255, 255, 0.1);
      margin: 1rem auto;
      padding: 1rem;
      border-radius: 0.6rem;
      max-width: 500px;
      text-align: left;
    }
    .details-wrapper {
      margin-top: 0.5rem;
      padding-left: 0.5rem;
      display: none;
    }
    button {
      margin-top: 0.4rem;
      padding: 0.3rem 0.6rem;
      border: none;
      background: #66d9ff;
      color: black;
      border-radius: 0.3rem;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h2>üìä Spielverlauf</h2>
  <div id="spielverlauf-liste"></div>

  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script>
    const socket = io();
    const name = localStorage.getItem('playerName') || 'Unbekannt';
    const key = 'spielverlauf_' + name;

    socket.on("trigger_dashboard_save", (data) => {
      const stats = data.stats || {};
      const spiel = {
        datum: new Date().toLocaleString(),
        modus: data.mode || "Fokus",
        dauer: Math.round(data.duration / 60) + " Min.",
        farben: data.colors || [],
        treffer: stats.treffer || 0,
        fehler: stats.fehler || 0,
        reaktionszeit: stats.avg_time || 0,
        details: stats.details || []
      };
      saveGameToLocalStorage(spiel);
      showSpielverlauf();
    });

    function saveGameToLocalStorage(spiel) {
      const gespeicherteSpiele = JSON.parse(localStorage.getItem(key) || '[]');
      gespeicherteSpiele.push(spiel);
      localStorage.setItem(key, JSON.stringify(gespeicherteSpiele));
    }

    function showSpielverlauf() {
      const spiele = JSON.parse(localStorage.getItem(key) || '[]');
      const container = document.getElementById('spielverlauf-liste');
      container.innerHTML = '';

      if (spiele.length === 0) {
        container.innerHTML = '<p>Keine Spiele vorhanden.</p>';
        return;
      }

      spiele.reverse().forEach((spiel, i) => {
        const div = document.createElement('div');
        div.classList.add('spiel-item');

        let html = `
          <strong>üïí ${spiel.datum}</strong><br>
          Modus: ${spiel.modus}<br>
          Dauer: ${spiel.dauer}<br>
          Farben: ${spiel.farben.join(', ')}<br>
          üéØ Treffer: ${spiel.treffer} | ‚ùå Fehler: ${spiel.fehler} | ‚è±Ô∏è √ò Reaktionszeit: ${spiel.reaktionszeit}s
          <br><button onclick="downloadFokusAuswertung(${i})">‚¨áÔ∏è‚¨áÔ∏è Download</button>`;

        if (spiel.details && spiel.details.length > 0) {
          html += `<button onclick="toggleDetails(${i})" id="toggleBtn_${i}">‚ñº</button>
                   <div class="details-wrapper" id="details_${i}">`;
          spiel.details.forEach((hit, j) => {
            html += `<div>Klick ${j + 1}: ${hit.time.toFixed(3)}s (Pod ${hit.pod})</div>`;
          });
          html += '</div>';
        }

        div.innerHTML = html;
        container.appendChild(div);
      });
    }

    function toggleDetails(index) {
      const el = document.getElementById('details_' + index);
      const btn = document.getElementById('toggleBtn_' + index);
      if (el.style.display === 'none' || el.style.display === '') {
        el.style.display = 'block';
        btn.textContent = '‚ñ≤';
      } else {
        el.style.display = 'none';
        btn.textContent = '‚ñº';
      }
    }

    function downloadFokusAuswertung(index) {
      const spiele = JSON.parse(localStorage.getItem(key) || '[]');
      const spiel = spiele.reverse()[index];
      let content = `Spieler: ${name}\nDatum: ${spiel.datum}\nModus: ${spiel.modus}\nDauer: ${spiel.dauer}\nFarben: ${spiel.farben.join(', ')}\nTreffer: ${spiel.treffer}\nFehler: ${spiel.fehler}\n√ò Reaktionszeit: ${spiel.reaktionszeit}s\n\nEinzeltreffer:\n`;
      spiel.details.forEach((entry, idx) => {
        content += `Klick ${idx + 1}: ${entry.time.toFixed(3)} s (Pod ${entry.pod})\n`;
      });
      const blob = new Blob([content], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `auswertung_fokus_${name}_${index + 1}.txt`;
      a.click();
      URL.revokeObjectURL(url);
    }

    window.onload = showSpielverlauf;
  </script>
</body>
</html>
